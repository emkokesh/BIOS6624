---
title: "Project1_Analysis_Frequentist"
output: html_document
---


Section 1: Load data

```{r}
library(tidyverse)
library(broom)

data <- read.csv("C:/Users/kokeshem/Spring 2026/Advanced Data Analysis/BIOS6624/Project1/DataProcessed/project1_clean.csv")
data



```

```{r}

# make sure categorical vars are factors
df_a <- df_a %>%
  mutate(
    hard_drugs_bl = factor(hard_drugs_bl),
    race_cat = factor(race_cat),
    educ_cat = factor(educ_cat),
    smoke = factor(smoke)
  )


#create baseline (Year 0) outcome covariates and merge onto Year 2
baseline_outcomes <- df_a %>%
  filter(years == 0) %>%
  select(newid, vload, leu3n, agg_phys, agg_ment) %>%
  rename(
    vload_bl = vload,
    leu3n_bl = leu3n,
    agg_phys_bl = agg_phys,
    agg_ment_bl = agg_ment
  )

df_y2 <- df_a %>%
  filter(years == 2) %>%
  left_join(baseline_outcomes, by = "newid") %>%
  mutate(
    log10_vload = ifelse(!is.na(vload) & vload > 0, log10(vload), NA_real_)
  )

#models 

#Viral load
m_vload_adh <- lm(
  log10_vload ~ hard_drugs_bl + vload_bl + adh_cat + age + bmi + race_cat + educ_cat + smoke_cat,
  data = df_y2
)
m_vload_noadh <- update(m_vload_adh, . ~ . - adh_cat)
summary(m_vload_adh); summary(m_vload_noadh)

#CD4 
m_leu3n_adh <- lm(
  leu3n ~ hard_drugs_bl + leu3n_bl + adh_cat + age + bmi + race_cat + educ_cat + smoke_cat,
  data = df_y2
)
m_leu3n_noadh <- update(m_leu3n_adh, . ~ . - adh_cat)
summary(m_leu3n_adh); summary(m_leu3n_noadh)

#Physical QOL
m_phys_adh <- lm(
  agg_phys ~ hard_drugs_bl + agg_phys_bl + adh_cat + age + bmi + race_cat + educ_cat + smoke_cat,
  data = df_y2
)
m_phys_noadh <- update(m_phys_adh, . ~ . - adh_cat)
summary(m_phys_adh);  summary(m_phys_noadh)

#Mental QOL
m_ment_adh <- lm(
  agg_ment ~ hard_drugs_bl + agg_ment_bl + adh_cat + age + bmi + race_cat + educ_cat + smoke_cat,
  data = df_y2
)
m_ment_noadh <- update(m_ment_adh, . ~ . - adh_cat)
summary(m_ment_adh);  summary(m_ment_noadh)



#pull key results

extract_terms <- function(model, terms_keep) {
  broom::tidy(model, conf.int = TRUE) %>%
    filter(term %in% terms_keep) %>%
    select(term, estimate, conf.low, conf.high, p.value)
}

terms_noadh <- c("hard_drugs_blYes")
terms_adh   <- c("hard_drugs_blYes", "adh")

results_vload <- list(
  with_adh = extract_terms(m_vload_adh, terms_adh),
  no_adh   = extract_terms(m_vload_noadh, terms_noadh)
)

results_leu3n <- list(
  with_adh = extract_terms(m_leu3n_adh, terms_adh),
  no_adh   = extract_terms(m_leu3n_noadh, terms_noadh)
)

results_phys <- list(
  with_adh = extract_terms(m_phys_adh, terms_adh),
  no_adh   = extract_terms(m_phys_noadh, terms_noadh)
)

results_ment <- list(
  with_adh = extract_terms(m_ment_adh, terms_adh),
  no_adh   = extract_terms(m_ment_noadh, terms_noadh)
)

results_vload
results_leu3n
results_phys
results_ment

```
```{r}
#diagnostic plots for linear model assumptions

run_lm_diagnostics <- function(model, model_name = deparse(formula(model))) {
  old_par <- par(no.readonly = TRUE)
  on.exit(par(old_par))
  
  par(mfrow = c(2, 2))
  
  #1) residuals vs fitted: linearity + constant variance
  plot(
    fitted(model), resid(model),
    xlab = "Fitted values",
    ylab = "Residuals",
    main = paste(model_name, "\nResiduals vs Fitted")
  )
  abline(h = 0, lty = 2)
  
  #2) histogram of residuals: normality
  hist(
    resid(model),
    main = paste(model_name, "\nResidual Histogram"),
    xlab = "Residuals",
    breaks = "FD"
  )
  
  #3) normal Q-Q plot: normality
  qqnorm(resid(model), main = paste(model_name, "\nNormal Q-Q Plot"))
  qqline(resid(model), lty = 2)
  
  #4) scale-location plot: constant variance (optional but useful)
  plot(
    fitted(model), sqrt(abs(scale(resid(model)))),
    xlab = "Fitted values",
    ylab = "Sqrt(|Standardized residuals|)",
    main = paste(model_name, "\nScale-Location")
  )
}

#run diagnostics for all primary models (with adherence)
run_lm_diagnostics(m_vload_adh, "Viral load (with adherence)")
run_lm_diagnostics(m_leu3n_adh, "CD4 (with adherence)")
run_lm_diagnostics(m_phys_adh,  "Physical QoL (with adherence)")
run_lm_diagnostics(m_ment_adh,  "Mental QoL (with adherence)")

#optional: diagnostics for no-adherence models too
run_lm_diagnostics(m_vload_noadh, "Viral load (no adherence)")
run_lm_diagnostics(m_leu3n_noadh, "CD4 (no adherence)")
run_lm_diagnostics(m_phys_noadh,  "Physical QoL (no adherence)")
run_lm_diagnostics(m_ment_noadh,  "Mental QoL (no adherence)")
```

