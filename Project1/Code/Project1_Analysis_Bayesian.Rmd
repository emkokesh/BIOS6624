---
title: "Project1_Analysis_Bayesian"
output: html_document
---

Section 1: Load and Factor data, 
```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(tibble)
library(cmdstanr)
library(bayesplot)
library(posterior)
library(bayestestR)
library(mcmcse)
library(loo)
library(knitr)
library(kableExtra)

path_dat <- file.path("C:/Users/kokeshem/Spring 2026/Advanced Data Analysis/BIOS6624/Project1/DataProcessed/project1_clean_final.csv")
df_y2 <- read.csv(path_dat)

df_y2 <- df_y2 %>%
  mutate(
    hard_drugs_bl = factor(hard_drugs_bl),
    race_cat_bl   = factor(race_cat_bl),
    educ_cat_bl   = factor(educ_cat_bl),
    smoke_cat_bl  = factor(smoke_cat_bl),
    adh_cat       = factor(adh_cat)
  )

stan_path <- write_stan_file("
data {
  int<lower=0> N;
  int<lower=0> P;
  matrix[N, P] X;
  vector[N] y;

  vector[P] prior_mean;
  vector<lower=0>[P] prior_sd;
  real<lower=0> sigma_prior_sd;
}
parameters {
  vector[P] beta;
  real<lower=0> sigma;
}
model {
  beta ~ normal(prior_mean, prior_sd);
  sigma ~ normal(0, sigma_prior_sd); // half-normal via <lower=0>
  y ~ normal(X * beta, sigma);
}
generated quantities {
  vector[N] log_lik;
  for (n in 1:N) {
    log_lik[n] = normal_lpdf(y[n] | X[n] * beta, sigma);
  }
}
", dir = "Code/STAN", basename = "project1_linear_regression_half_normal")

mod <- cmdstan_model(stan_path)
```


```{r}
#set priors
# beta_j ~ Normal(0, 1000^2)
# sigma  ~ Half-Normal(0, 100^2) 
make_priors <- function(P, beta_mean = 0, beta_sd = 1000, sigma_sd = 100) {
  list(
    prior_mean = rep(beta_mean, P),
    prior_sd   = rep(beta_sd, P),
    sigma_prior_sd = sigma_sd
  )
}

fit_bayes_lm <- function(formula, data, seed = 123,
                         chains = 4, iter_warmup = 1000, iter_sampling = 2000,
                         refresh = 500) {

  mf <- model.frame(formula, data = data, na.action = na.omit)
  y  <- model.response(mf)

  X <- model.matrix(formula, data = mf)

  N <- nrow(X)
  P <- ncol(X)

  pri <- make_priors(P = P)

  data_list <- list(
    N = N, P = P,
    X = X,
    y = as.vector(y),
    prior_mean = pri$prior_mean,
    prior_sd = pri$prior_sd,
    sigma_prior_sd = pri$sigma_prior_sd
  )

  fit <- mod$sample(
    data = data_list,
    chains = chains,
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling,
    seed = seed,
    refresh = refresh
  )

  list(
    fit = fit,
    X = X,
    y = y,
    coef_names = colnames(X),
    N = N,
    P = P
  )
}

get_hd_col_index <- function(coef_names, var = "hard_drugs_bl") {
  idx <- which(grepl(paste0("^", var), coef_names))
  if (length(idx) == 0) stop("No coefficient found starting with: ", var, " in coef_names")
  if (length(idx) > 1) warning("Multiple hard_drugs_bl columns found; using first: ", coef_names[idx[1]])
  idx[1]
}

summ_draws <- function(draw_vec, ci = 0.95) {
  h <- bayestestR::hdi(draw_vec, ci = ci)
  tibble(
    estimate = mean(draw_vec),
    ci_low   = h$CI_low,
    ci_high  = h$CI_high
  )
}

summ_fold_change <- function(beta_draws, ci = 0.95) {
  fc <- 10^beta_draws
  h <- bayestestR::hdi(fc, ci = ci)
  tibble(
    estimate = mean(fc),
    ci_low   = h$CI_low,
    ci_high  = h$CI_high
  )
}

pp_gt0 <- function(draw_vec) mean(draw_vec > 0)
pp_gt1 <- function(draw_vec) mean(draw_vec > 1)

fmt_num <- function(x, digits = 3) formatC(x, format = "f", digits = digits)
fmt_ci  <- function(lo, hi, digits = 3) paste0(fmt_num(lo, digits), ", ", fmt_num(hi, digits))
fmt_prob <- function(p) {
  ifelse(is.na(p), NA_character_,
         ifelse(p > 0.999, ">0.999",
                ifelse(p < 0.001, "<0.001", formatC(p, format = "f", digits = 3))))
}

build_outcome_row_bayes <- function(outcome_label,
                                    fit_noadh, fit_adh,
                                    hd_idx_noadh, hd_idx_adh,
                                    transform = c("none", "vload"),
                                    ci = 0.95) {

  transform <- match.arg(transform)

  draws_noadh <- as_draws_matrix(fit_noadh$fit$draws(variables = "beta"))
  draws_adh   <- as_draws_matrix(fit_adh$fit$draws(variables = "beta"))

  b0 <- as.numeric(draws_noadh[, paste0("beta[", hd_idx_noadh, "]")])
  b1 <- as.numeric(draws_adh[,   paste0("beta[", hd_idx_adh,   "]")])

  if (transform == "vload") {
    s0 <- summ_fold_change(b0, ci = ci)
    s1 <- summ_fold_change(b1, ci = ci)
    prob0 <- pp_gt1(10^b0)  # fold-change > 1
    prob1 <- pp_gt1(10^b1)
  } else {
    s0 <- summ_draws(b0, ci = ci)
    s1 <- summ_draws(b1, ci = ci)
    prob0 <- pp_gt0(b0)
    prob1 <- pp_gt0(b1)
  }

  pct_change <- ifelse(is.na(s0$estimate) | s0$estimate == 0,
                       NA_real_,
                       100 * (s1$estimate - s0$estimate) / s0$estimate)

  tibble(
    Outcome = outcome_label,

    `Estimate (No ADH)` = s0$estimate,
    `CI low (No ADH)`   = s0$ci_low,
    `CI high (No ADH)`  = s0$ci_high,
    `Pr(Effect > 0/1) (No ADH)` = prob0,

    `Estimate (With ADH)` = s1$estimate,
    `CI low (With ADH)`   = s1$ci_low,
    `CI high (With ADH)`  = s1$ci_high,
    `Pr(Effect > 0/1) (With ADH)` = prob1,

    `% change (No→With ADH)` = pct_change
  )
}
```

#models
```{r}
f_vload_adh   <- log10_vload ~ hard_drugs_bl + log10_vload_bl + adh_cat +
  age_bl + bmi_bl + race_cat_bl + educ_cat_bl + smoke_cat_bl
f_vload_noadh <- update(f_vload_adh, . ~ . - adh_cat)

f_leu3n_adh   <- leu3n ~ hard_drugs_bl + leu3n_bl + adh_cat +
  age_bl + bmi_bl + race_cat_bl + educ_cat_bl + smoke_cat_bl
f_leu3n_noadh <- update(f_leu3n_adh, . ~ . - adh_cat)

f_phys_adh   <- agg_phys ~ hard_drugs_bl + agg_phys_bl + adh_cat +
  age_bl + bmi_bl + race_cat_bl + educ_cat_bl + smoke_cat_bl
f_phys_noadh <- update(f_phys_adh, . ~ . - adh_cat)

f_ment_adh   <- agg_ment ~ hard_drugs_bl + agg_ment_bl + adh_cat +
  age_bl + bmi_bl + race_cat_bl + educ_cat_bl + smoke_cat_bl
f_ment_noadh <- update(f_ment_adh, . ~ . - adh_cat)

fit_vload_noadh <- fit_bayes_lm(f_vload_noadh, df_y2, seed = 1001)
fit_vload_adh   <- fit_bayes_lm(f_vload_adh,   df_y2, seed = 1002)

fit_leu3n_noadh <- fit_bayes_lm(f_leu3n_noadh, df_y2, seed = 2001)
fit_leu3n_adh   <- fit_bayes_lm(f_leu3n_adh,   df_y2, seed = 2002)

fit_phys_noadh  <- fit_bayes_lm(f_phys_noadh,  df_y2, seed = 3001)
fit_phys_adh    <- fit_bayes_lm(f_phys_adh,    df_y2, seed = 3002)

fit_ment_noadh  <- fit_bayes_lm(f_ment_noadh,  df_y2, seed = 4001)
fit_ment_adh    <- fit_bayes_lm(f_ment_adh,    df_y2, seed = 4002)

hd_vload_noadh <- get_hd_col_index(fit_vload_noadh$coef_names, "hard_drugs_bl")
hd_vload_adh   <- get_hd_col_index(fit_vload_adh$coef_names,   "hard_drugs_bl")

hd_leu3n_noadh <- get_hd_col_index(fit_leu3n_noadh$coef_names, "hard_drugs_bl")
hd_leu3n_adh   <- get_hd_col_index(fit_leu3n_adh$coef_names,   "hard_drugs_bl")

hd_phys_noadh  <- get_hd_col_index(fit_phys_noadh$coef_names,  "hard_drugs_bl")
hd_phys_adh    <- get_hd_col_index(fit_phys_adh$coef_names,    "hard_drugs_bl")

hd_ment_noadh  <- get_hd_col_index(fit_ment_noadh$coef_names,  "hard_drugs_bl")
hd_ment_adh    <- get_hd_col_index(fit_ment_adh$coef_names,    "hard_drugs_bl")
```


```{r}
tab_bayes <- bind_rows(
  build_outcome_row_bayes(
    outcome_label = "Viral Load (fold-change; 10^β) [Year 2 log10 outcome]",
    fit_noadh = fit_vload_noadh, fit_adh = fit_vload_adh,
    hd_idx_noadh = hd_vload_noadh, hd_idx_adh = hd_vload_adh,
    transform = "vload"
  ),
  build_outcome_row_bayes(
    outcome_label = "CD4+ T-Cell Count (cells/mm³)",
    fit_noadh = fit_leu3n_noadh, fit_adh = fit_leu3n_adh,
    hd_idx_noadh = hd_leu3n_noadh, hd_idx_adh = hd_leu3n_adh,
    transform = "none"
  ),
  build_outcome_row_bayes(
    outcome_label = "Aggregate Physical QOL Score",
    fit_noadh = fit_phys_noadh, fit_adh = fit_phys_adh,
    hd_idx_noadh = hd_phys_noadh, hd_idx_adh = hd_phys_adh,
    transform = "none"
  ),
  build_outcome_row_bayes(
    outcome_label = "Aggregate Mental QOL Score",
    fit_noadh = fit_ment_noadh, fit_adh = fit_ment_adh,
    hd_idx_noadh = hd_ment_noadh, hd_idx_adh = hd_ment_adh,
    transform = "none"
  )
) %>%
  mutate(
    `Estimate (No ADH)` = fmt_num(`Estimate (No ADH)`),
    `95% CrI (No ADH)`  = fmt_ci(`CI low (No ADH)`, `CI high (No ADH)`),
    `Pr(Effect > 0/1) (No ADH)` = fmt_prob(`Pr(Effect > 0/1) (No ADH)`),

    `Estimate (With ADH)` = fmt_num(`Estimate (With ADH)`),
    `95% CrI (With ADH)`  = fmt_ci(`CI low (With ADH)`, `CI high (With ADH)`),
    `Pr(Effect > 0/1) (With ADH)` = fmt_prob(`Pr(Effect > 0/1) (With ADH)`),

    `% change (No→With ADH)` = ifelse(is.na(`% change (No→With ADH)`),
                                      NA_character_,
                                      paste0(formatC(`% change (No→With ADH)`, format = "f", digits = 1), "%"))
  ) %>%
  select(
    Outcome,
    `Estimate (No ADH)`, `95% CrI (No ADH)`, `Pr(Effect > 0/1) (No ADH)`,
    `Estimate (With ADH)`, `95% CrI (With ADH)`, `Pr(Effect > 0/1) (With ADH)`,
    `% change (No→With ADH)`
  )

tab_bayes %>%
  kbl(
    caption = "Bayesian association of baseline hard drug use (Yes vs No) with Year 2 outcomes: models with and without adherence adjustment",
    align = c("l", rep("c", 7)),
    booktabs = TRUE
  ) %>%
  add_header_above(c(" " = 1, "Model Without ADH" = 3, "Model With ADH" = 3, " " = 1)) %>%
  kable_classic(full_width = FALSE, html_font = "Arial") %>%
  column_spec(1, width = "3.2in") %>%
  column_spec(2:8, width = "1.15in") %>%
  footnote(
    general =
      "Estimates are posterior means for baseline hard drug use (Yes vs No). 95% CrI = 95% highest density interval (HDI). Viral load is reported as fold-change (10^β) because the outcome is log10(vload). For viral load, Pr(Effect > 0/1) is Pr(fold-change > 1); for other outcomes it is Pr(beta > 0). All models adjust for baseline outcome value and baseline covariates (age, BMI, race, education, smoking). Priors: beta_j ~ Normal(0, 1000^2); sigma ~ Half-Normal(0, 100^2).",
    general_title = "Note: ",
    footnote_as_chunk = TRUE
  )
```


