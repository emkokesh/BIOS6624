---
title: "Project1_EDA.Rmd"
output: html_document
---

Section 0: Load Data
```{r}
library(tidyverse)
library(janitor)
library(skimr)
library(broom)
library(gtsummary)

path_raw <- "C:/Users/kokeshem/Spring 2026/Advanced Statistical Methods/Project 1/hiv_6624_final.csv"

#load data
df <- read.csv(path_raw, na.strings = c("", "NA")) %>%
  clean_names()

#inspect data
names(df)
``` 

Section 1: Data and Structure Checks, Missingness, create analytic Dataset
```{r}
#drop index column
df <- df %>% select(-any_of("x"))
glimpse(df)

#quick structure check- number of unique individuals per year
df %>% summarise(
  n_rows = n(),
  n_subjects = n_distinct(newid),
  min_year = min(years, na.rm = TRUE),
  max_year = max(years, na.rm = TRUE)
)

df %>% count(years) %>% arrange(years)

#visits per subject
visits_by_id <- df %>% count(newid, name = "n_visits")
summary(visits_by_id$n_visits)

#quick visit distribution summary
df %>%
  count(newid, name = "n_visits") %>%
  summarise(
    min_visits = min(n_visits),
    p25_visits = quantile(n_visits, 0.25),
    median_visits = median(n_visits),
    p75_visits = quantile(n_visits, 0.75),
    max_visits = max(n_visits)
  )

#check that art is 0 at year 0 and 1 at every other year
df %>%
  group_by(years) %>%
  summarise(
    n = n(),
    prop_art_1 = mean(art == 1, na.rm = TRUE),
    prop_art_missing = mean(is.na(art))
  ) %>%
  arrange(years)

#create a subject level baseline (year 0) hard drug use indicator and merge it onto all follow up rows
baseline_exposure <- df %>%
  filter(years == 0) %>%
  select(newid, hard_drugs) %>%
  rename(hard_drugs_bl = hard_drugs)

df2 <- df %>% left_join(baseline_exposure, by = "newid")

df2 %>%
  distinct(newid, hard_drugs_bl) %>%
  count(hard_drugs_bl, name = "n_subjects")

df2 %>%
  summarise(
    n_subjects = n_distinct(newid),
    prop_missing_hard_drugs_bl = mean(is.na(hard_drugs_bl))
  )

#replace these bmi values with na and bmi>80 with na
df2 <- df2 %>%
  mutate(
    bmi = na_if(bmi, 999),
    bmi = na_if(bmi, -1),
    bmi = ifelse(!is.na(bmi) & bmi > 80, NA, bmi)
  )

#create analysis dataset with only required covariates
analysis_vars <- c(
  "newid", "years",
  "hard_drugs_bl",
  "vload", "leu3n", "agg_phys", "agg_ment",
  "age", "bmi", "educbas", "race", "smoke", "adh"
)
df_a0 <- df2 %>%
  select(all_of(analysis_vars))

#merge levels of race and education
unique(df_a0$race)

df_a1 <- df_a0 %>%
  mutate(
    race_cat = case_when(
      race == 1              ~ "White (NH)",
      race == 3              ~ "Black (NH)",
      race %in% c(2, 4, 7, 8) ~ "Hispanic, Other",
      TRUE ~ NA_character_
    ),
    educ_cat = case_when(
      educbas %in% c(1, 2) ~ "<HS",
      educbas == 3 ~ "HS/GED",
      educbas == 4 ~ "Some college",
      educbas %in% c(5, 6, 7) ~ "College+",
      TRUE ~ NA_character_
    )
  )

#factor categorical variables
df_a <- df_a1 %>%
  mutate(
    race_cat = factor(race_cat, levels = c("White (NH)", "Black (NH)", "Hispanic, Other")),
    educ_cat = factor(educ_cat, levels = c("<HS", "HS/GED", "Some college", "College+")),
    smoke = factor(smoke),
    hard_drugs_bl = factor(hard_drugs_bl)
  )

#convert hard_drugs_bl labels to yes/no
df_a <- df_a %>%
  mutate(
    hard_drugs_bl = fct_recode(hard_drugs_bl, "No" = "0", "Yes" = "1")
  )

#check the new counts at baseline
df_a %>% filter(years == 0) %>% count(race_cat, sort = TRUE)
df_a %>% filter(years == 0) %>% count(educ_cat, sort = TRUE)

#check smoke at baseline
df_a %>% filter(years == 0) %>% count(smoke, sort = TRUE)

#check baseline sample size and group balance
df_bl <- df_a %>% filter(years == 0)

#how many subjects total and per group
df_bl %>%
  distinct(newid, hard_drugs_bl) %>%
  count(hard_drugs_bl)

#check baseline covariate distributions by exposure
df_bl %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n = n_distinct(newid),
    age_mean = mean(age, na.rm = TRUE),
    bmi_mean = mean(bmi, na.rm = TRUE)
  )

df_bl %>% count(hard_drugs_bl)

#check baseline sample size and group balance
df_y2 <- df_a %>% filter(years == 2)


#how many subjects total and per group
df_y2 %>%
  distinct(newid, hard_drugs_bl) %>%
  count(hard_drugs_bl)

#check baseline covariate distributions by exposure
df_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n = n_distinct(newid),
    age_mean = mean(age, na.rm = TRUE),
    bmi_mean = mean(bmi, na.rm = TRUE)
  )

df_y2 %>% count(hard_drugs_bl)


#check year 2 availability (dropout) by baseline hard drug group
have_y2 <- df_a %>%
  group_by(newid) %>%
  summarise(
    have_year2 = any(years == 2),
    hard_drugs_bl = first(hard_drugs_bl)
  )

have_y2 %>% count(have_year2)
have_y2 %>% count(hard_drugs_bl, have_year2)

have_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n = n(),
    prop_have_y2 = mean(have_year2)
  )

#missingness at year 2 for each outcome (by baseline hard drug group)
df_y2 <- df_a %>% filter(years == 2)

#overall year 2 adherence missingness (all subjects with a year 2 visit)
df_y2 %>%
  summarise(
    n_rows = n(),
    n_subjects = n_distinct(newid),
    prop_missing_adh = mean(is.na(adh))
  )

#year 2 adherence missingness by baseline hard drug group
df_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n_subjects = n_distinct(newid),
    miss_vload = mean(is.na(vload)),
    miss_leu3n = mean(is.na(leu3n)),
    miss_agg_phys = mean(is.na(agg_phys)),
    miss_agg_ment = mean(is.na(agg_ment)),
    miss_adh = mean(is.na(adh))
  )

#year 2 missingness for key covariates
df_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    miss_age = mean(is.na(age)),
    miss_bmi = mean(is.na(bmi)),
    miss_race = mean(is.na(race_cat)),
    miss_educ = mean(is.na(educ_cat)),
    miss_smoke = mean(is.na(smoke))
  )

#baseline covariate missingness (exclude adh because it is not measured at year 0)
df_bl %>%
  summarise(across(c(age, bmi, race_cat, educ_cat, smoke, hard_drugs_bl),
                   ~ mean(is.na(.)))) %>%
  pivot_longer(everything(), names_to="var", values_to="prop_missing") %>%
  arrange(desc(prop_missing))


```



#Section 2: Check outliers/impossible values for all covariates and outcomes, create final analytical dataset (df_a)

```{r}
#check outliers/impossible values for all covariates and outcomes

#restrict to years 0 and 2
df_02 <- df_a %>%
  filter(years %in% c(0, 2)) %>%
  mutate(
    #create flags for potential issues
    flag_vload_neg = !is.na(vload) & vload < 0,
    flag_vload_hi  = !is.na(vload) & vload > 1000000,     #>1,000,000 copies/mL (rare but possible)

    flag_cd4_nonpos = !is.na(leu3n) & leu3n <= 0,
    flag_cd4_hi     = !is.na(leu3n) & leu3n > 3000,        #very high; flag for review

    flag_bmi_low = !is.na(bmi) & bmi < 10,                 #extreme low
    flag_bmi_hi  = !is.na(bmi) & bmi > 80,                 #extreme high

    flag_age_low = !is.na(age) & age < 18,                 #cohort is adult men, flag <18
    flag_age_hi  = !is.na(age) & age > 100,                #extreme high

    flag_phys_out = !is.na(agg_phys) & (agg_phys < 0 | agg_phys > 100),
    flag_ment_out = !is.na(agg_ment) & (agg_ment < 0 | agg_ment > 100),

    # any issue on this row?
    flag_any_issue = flag_vload_neg | flag_vload_hi |
      flag_cd4_nonpos | flag_cd4_hi |
      flag_bmi_low | flag_bmi_hi |
      flag_age_low | flag_age_hi |
      flag_phys_out | flag_ment_out
  )

#one table of all observations with any flag + what the problem is
issues_tbl <- df_02 %>%
  filter(flag_any_issue) %>%
  mutate(
    issue = case_when(
      flag_vload_neg ~ "vload < 0",
      flag_vload_hi  ~ "vload > 1,000,000",
      flag_cd4_nonpos ~ "leu3n <= 0",
      flag_cd4_hi     ~ "leu3n > 3000",
      flag_bmi_low    ~ "bmi < 10",
      flag_bmi_hi     ~ "bmi > 80",
      flag_age_low    ~ "age < 18",
      flag_age_hi     ~ "age > 100",
      flag_phys_out   ~ "agg_phys outside 0-100",
      flag_ment_out   ~ "agg_ment outside 0-100",
      TRUE ~ NA_character_
    )
  ) %>%
  select(
    newid, years,
    vload, leu3n, bmi, age, agg_phys, agg_ment,
    issue
  ) %>%
  arrange(newid, years)

issues_tbl

#remove BMI values that are too high (set to NA)
df_a <- df_a %>%
  mutate(
    bmi = ifelse(!is.na(bmi) & bmi > 80, NA, bmi)
  )

```

Section 3: Table 1
```{r}
library(gtsummary)

#filter for baseline
table1_data <- df_a %>% 
  filter(years == 0) %>%
  #select the variables that describe the subjects at baseline
  select(hard_drugs_bl, age, bmi, race_cat, educ_cat, smoke, vload, leu3n, agg_phys, agg_ment)

#create the table
table1 <- table1_data %>%
  tbl_summary(
    by = hard_drugs_bl,
    label = list(
      age ~ "Age (years)",
      bmi ~ "BMI (kg/mÂ²)",
      race_cat ~ "Race/Ethnicity",
      educ_cat ~ "Education Level",
      smoke ~ "Smoking Status",
      vload ~ "Baseline Viral Load",
      leu3n ~ "Baseline CD4+ Count",
      agg_phys ~ "Baseline Physical QoL",
      agg_ment ~ "Baseline Mental QoL"
    ),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      vload ~ "{median} ({p25}, {p75})" 
    ),
    missing_text = "(Missing)"
  ) %>%
  add_p(test = list(all_continuous() ~ "t.test", all_categorical() ~ "chisq.test")) %>% 
  add_overall() %>%
  modify_caption("**Table 1. Baseline Characteristics of Participants by Hard Drug Use Status (n = 715)**") %>%
  modify_header(label = "**Variable**") %>%
  bold_labels()

table1

```

```{r}
# Summary of Outcomes at Year 2
table2_outcomes <- df_a %>%
  filter(years == 2) %>%
  select(hard_drugs_bl, vload, leu3n, agg_phys, agg_ment, adh) %>%
  tbl_summary(
    by = hard_drugs_bl,
    label = list(
      vload ~ "Year 2 Viral Load",
      leu3n ~ "Year 2 CD4+ Count",
      adh ~ "Year 2 Adherence Score"
    )
  ) %>%
  add_p() %>%
  modify_caption("**Table 2. Treatment Response and Adherence at 2-Year Follow-up**")

table2_outcomes
```


```{r}
#assess whether transformations of variables are needed
#restrict to year 2 data
df_y2 <- df_a %>%
  filter(years == 2)

# raw distributions
ggplot(df_y2, aes(x = vload)) + geom_histogram(bins = 60) + labs(title = "Year 2: VLOAD (raw)")
ggplot(df_y2, aes(x = leu3n)) + geom_histogram(bins = 60) + labs(title = "Year 2: LEU3N (raw)")
ggplot(df_y2, aes(x = agg_phys)) + geom_histogram(bins = 40) + labs(title = "Year 2: AGG_PHYS (raw)")
ggplot(df_y2, aes(x = agg_ment)) + geom_histogram(bins = 40) + labs(title = "Year 2: AGG_MENT (raw)")

#log transformations on vload and leu3n
ggplot(df_y2, aes(x = log10(vload+1))) + geom_histogram(bins = 60) + labs(title = "Year 2: log10(VLOAD+1)")
ggplot(df_y2, aes(x = log(leu3n))) + geom_histogram(bins = 60) + labs(title = "Year 2: log(LEU3N)")

```


```{r}
#year 2 dataset and transformations used for plots
df_y2 <- df_a %>%
  filter(years == 2) %>%
  mutate(
    log10_vload = ifelse(!is.na(vload), log10(vload + 1), NA_real_)
  )

#summary statistics by exposure group (year 2)
y2_summary <- df_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n_subjects = n_distinct(newid),

    vload_med = median(vload, na.rm = TRUE),
    vload_p25 = quantile(vload, 0.25, na.rm = TRUE),
    vload_p75 = quantile(vload, 0.75, na.rm = TRUE),

    log10_vload_mean = mean(log10_vload, na.rm = TRUE),
    log10_vload_sd   = sd(log10_vload, na.rm = TRUE),
    log10_vload_med  = median(log10_vload, na.rm = TRUE),

    leu3n_mean = mean(leu3n, na.rm = TRUE),
    leu3n_sd   = sd(leu3n, na.rm = TRUE),
    leu3n_med  = median(leu3n, na.rm = TRUE),

    agg_phys_mean = mean(agg_phys, na.rm = TRUE),
    agg_phys_sd   = sd(agg_phys, na.rm = TRUE),
    agg_phys_med  = median(agg_phys, na.rm = TRUE),

    agg_ment_mean = mean(agg_ment, na.rm = TRUE),
    agg_ment_sd   = sd(agg_ment, na.rm = TRUE),
    agg_ment_med  = median(agg_ment, na.rm = TRUE)
  )

y2_summary

#boxplots for year 2 outcomes by baseline hard drug use
ggplot(df_y2, aes(x = hard_drugs_bl, y = log10_vload)) +
  geom_boxplot() +
  labs(title = "Year 2 Viral Load by Baseline Hard Drug Use",
       x = NULL, y = "log10(VLOAD+1)")

ggplot(df_y2, aes(x = hard_drugs_bl, y = leu3n)) +
  geom_boxplot() +
  labs(title = "Year 2 CD4 (LEU3N) by Baseline Hard Drug Use",
       x = NULL, y = "LEU3N")

ggplot(df_y2, aes(x = hard_drugs_bl, y = agg_phys)) +
  geom_boxplot() +
  labs(title = "Year 2 Physical QoL by Baseline Hard Drug Use",
       x = NULL, y = "AGG_PHYS")

ggplot(df_y2, aes(x = hard_drugs_bl, y = agg_ment)) +
  geom_boxplot() +
  labs(title = "Year 2 Mental QoL by Baseline Hard Drug Use",
       x = NULL, y = "AGG_MENT")

```



