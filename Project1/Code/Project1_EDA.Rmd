---
title: "Project1_EDA.Rmd"
output: html_document
---
```{r}
library(tidyverse)
library(janitor)
library(skimr)

path_raw <- "C:/Users/kokeshem/Spring 2026/Advanced Statistical Methods/Project 1/hiv_6624_final.csv"

#load data
df <- read.csv(path_raw, na.strings = c("", "NA")) %>%
  clean_names()

#inspect data
names(df)

#drop index column
df <- df %>% select(-any_of("x"))
glimpse(df)

#quick structure check- number of unique individuals per year
df %>% summarise(
  n_rows = n(),
  n_subjects = n_distinct(newid),
  min_year = min(years, na.rm = TRUE),
  max_year = max(years, na.rm = TRUE)
)

df %>% count(years) %>% arrange(years)

#visits per subject
visits_by_id <- df %>% count(newid, name = "n_visits")
summary(visits_by_id$n_visits)


#check that art is 0 at year 0 and 1 at every other year
df %>%
  group_by(years) %>%
  summarise(
    n = n(),
    prop_art_1 = mean(art == 1, na.rm = TRUE),
    prop_art_missing = mean(is.na(art))
  ) %>%
  arrange(years)


#create a subject level baseline (year 0) hard drug use indicator and merge it onto all follow up rows

baseline_exposure <- df %>%
  filter(years == 0) %>%
  select(newid, hard_drugs) %>%
  rename(hard_drugs_bl = hard_drugs)

df2 <- df %>% left_join(baseline_exposure, by = "newid")

df2 %>%
  distinct(newid, hard_drugs_bl) %>%
  count(hard_drugs_bl, name = "n_subjects")

df2 %>%
  summarise(
    n_subjects = n_distinct(newid),
    prop_missing_hard_drugs_bl = mean(is.na(hard_drugs_bl))
  )


#create analysis dataset with only required covariates
analysis_vars <- c(
  "newid", "years",
  "hard_drugs_bl",
  "vload", "leu3n", "agg_phys", "agg_ment",
  "age", "bmi", "educbas", "race", "smoke", "adh"
)
df_a0 <- df2 %>%
  select(all_of(analysis_vars))

#merge levels of race and education
unique(df$race)


df_a1 <- df_a0 %>%
  mutate(
    race_cat = case_when(
      race == 1            ~ "White (NH)",
      race == 3            ~ "Black (NH)",
      race %in% c(2, 4, 8) ~ "Hispanic",
      race == 7            ~ "Other",
      TRUE ~ NA_character_
    ),
    educ_cat = case_when(
      educbas %in% c(1, 2) ~ "<HS",
      educbas == 3 ~ "HS/GED",
      educbas == 4 ~ "Some college",
      educbas %in% c(5, 6, 7) ~ "College+",
      TRUE ~ NA_character_
    )
  )


#factor categorical variables
df_a <- df_a1 %>%
  mutate(
    race_cat = factor(race_cat, levels = c("White (NH)", "Black (NH)", "Hispanic", "Other")),
    educ_cat = factor(educ_cat, levels = c("<HS", "HS/GED", "Some college", "College+")),
    smoke = factor(smoke),
    hard_drugs_bl = factor(hard_drugs_bl)
  )


#check the new counts at baseline
df_a %>% filter(years == 0) %>% count(race_cat, sort = TRUE)
df_a %>% filter(years == 0) %>% count(educ_cat, sort = TRUE)


```

```{r}

#check baseline sample size and group balance
df_bl <- df_a %>% filter(years == 0)

#how many subjects total and per group
df_bl %>%
  distinct(newid, hard_drugs_bl) %>%
  count(hard_drugs_bl)

#check baseline covariate distributions by exposure
df_bl %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n = n_distinct(newid),
    age_mean = mean(age, na.rm = TRUE),
    bmi_mean = mean(bmi, na.rm = TRUE)
  )

df_bl %>% count(hard_drugs_bl, race_cat)
df_bl %>% count(hard_drugs_bl, educ_cat)
df_bl %>% count(hard_drugs_bl, smoke)


#change grouping of categorical race for more balanced groups
df_a <- df_a %>%
  mutate(
    race_cat2 = fct_collapse(
      race_cat,
      "White (NH)" = "White (NH)",
      "Black (NH)" = "Black (NH)",
      "Hispanic/Other" = c("Hispanic", "Other")
    )
  )



```

```{r}
#check year 2 availability (dropout) by baseline hard drug group
have_y2 <- df_a %>%
  group_by(newid) %>%
  summarise(
    have_year2 = any(years == 2),
    hard_drugs_bl = first(hard_drugs_bl)
  )

have_y2 %>% count(have_year2)
have_y2 %>% count(hard_drugs_bl, have_year2)

have_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n = n(),
    prop_have_y2 = mean(have_year2)
  )

```

```{r}
#Missingness at year 2 for each outcome (by baseline hard drug group)
df_y2 <- df_a %>% filter(years == 2)

df_y2 %>%
  group_by(hard_drugs_bl) %>%
  summarise(
    n_subjects = n_distinct(newid),
    miss_vload = mean(is.na(vload)),
    miss_leu3n = mean(is.na(leu3n)),
    miss_agg_phys = mean(is.na(agg_phys)),
    miss_agg_ment = mean(is.na(agg_ment))
  )

df_bl %>%
  summarise(across(c(age, bmi, race_cat, educ_cat, smoke, hard_drugs_bl),
                   ~ mean(is.na(.)))) %>%
  pivot_longer(everything(), names_to="var", values_to="prop_missing") %>%
  arrange(desc(prop_missing))


```

```{r}
df_a <- df_a %>%
  mutate(
    log10_vload = ifelse(!is.na(vload), log10(vload + 1), NA_real_),
    log_leu3n = ifelse(!is.na(leu3n) & leu3n > 0, log(leu3n), NA_real_)
  )

# overall distributions
ggplot(df_a, aes(x = vload)) + geom_histogram(bins = 60) + labs(title = "VLOAD (raw)")
ggplot(df_a, aes(x = log10_vload)) + geom_histogram(bins = 60) + labs(title = "VLOAD (log10(vload+1))")
ggplot(df_a, aes(x = leu3n)) + geom_histogram(bins = 60) + labs(title = "LEU3N (raw)")
ggplot(df_a, aes(x = agg_phys)) + geom_histogram(bins = 40) + labs(title = "AGG_PHYS")
ggplot(df_a, aes(x = agg_ment)) + geom_histogram(bins = 40) + labs(title = "AGG_MENT")

# year 2 only
ggplot(df_y2, aes(x = log10(vload + 1))) + geom_histogram(bins = 50) + labs(title = "Year 2: log10(VLOAD+1)")
ggplot(df_y2, aes(x = leu3n)) + geom_histogram(bins = 50) + labs(title = "Year 2: LEU3N")

```

```{r}
ggplot(df_y2, aes(x = hard_drugs_bl, y = log10(vload + 1))) +
  geom_boxplot() +
  labs(title="Year 2 Viral Load by Baseline Hard Drug Use", x=NULL, y="log10(VLOAD+1)")

ggplot(df_y2, aes(x = hard_drugs_bl, y = leu3n)) +
  geom_boxplot() +
  labs(title="Year 2 CD4 by Baseline Hard Drug Use", x=NULL, y="LEU3N")

ggplot(df_y2, aes(x = hard_drugs_bl, y = agg_phys)) +
  geom_boxplot() +
  labs(title="Year 2 Physical QoL by Baseline Hard Drug Use", x=NULL, y="AGG_PHYS")

ggplot(df_y2, aes(x = hard_drugs_bl, y = agg_ment)) +
  geom_boxplot() +
  labs(title="Year 2 Mental QoL by Baseline Hard Drug Use", x=NULL, y="AGG_MENT")

```

