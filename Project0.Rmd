---
title: "Cortisol"
author: "Emily Kokesh"
date: "2026-01-26"
output: html_document
documentclass: article
geometry: margin=1in
fontsize: 12pt
linestretch: 2
fig.cap: true
---
## Data loading and cleaning, missingness analysis
```{r}
# load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(lubridate)
library(knitr)
library(broom.mixed)


# load data
path <- "C:/Users/kokeshem/Spring 2026/Advanced Statistical Methods/Project0_Clean_v2.csv"
df <- read.csv(path, na.strings = c("", "NA"))

# data cleaning, renaming, trimming

df <- df %>% 
  rename(
    Booklet_Clock_Time = Booket..Clock.Time, 
    MEMs_Clock_Time = MEMs..Clock.Time,
    Wake_Time = Sleep.Diary.reported.wake.time,
    Cortisol_nmol = Cortisol..nmol.L.,
    DHEA_nmol = DHEA..nmol.L.
  ) %>%
  #remove unnecessary columns for analysis
  select(
    SubjectID, 
    Collection.Date, 
    Collection.Sample, 
    DAYNUMB,
    Booklet_Clock_Time, 
    MEMs_Clock_Time, 
    Wake_Time, 
    Cortisol_nmol, 
    DHEA_nmol
  )

#fill wake time so each sample per day has the same wake time
df <- df %>%
  group_by(SubjectID, Collection.Date) %>%
  fill(Wake_Time, .direction = "downup") %>%
  ungroup()

#helper function
to_mins <- function(time_str) {
  t <- hm(time_str, quiet = TRUE)
  return(as.numeric(t) / 60)
}

#calculate minutes since waking
df <- df %>%
  mutate(
    Wake_Min = to_mins(Wake_Time),
    Booklet_Clock_Min = to_mins(Booklet_Clock_Time),
    MEMs_Clock_Min = to_mins(MEMs_Clock_Time),
    
    #final analysis variables
    Booklet_Min_Since_Wake = Booklet_Clock_Min - Wake_Min,
    MEMs_Min_Since_Wake = MEMs_Clock_Min - Wake_Min
  )

#check simplified structure
str(df)
view(df)

#create missing data frame
missing_table <- data.frame(
  variable = c("mems cap time", "booklet time", "cortisol level", "dhea level"),
  missing_count = c(
    sum(is.na(df$MEMs_Clock_Time)),
    sum(is.na(df$Booklet_Clock_Time)),
    sum(is.na(df$Cortisol_nmol)),
    sum(is.na(df$DHEA_nmol))
  ),
  percentage = c(
    mean(is.na(df$MEMs_Clock_Time)) * 100,
    mean(is.na(df$Booklet_Clock_Time)) * 100,
    mean(is.na(df$Cortisol_nmol)) * 100,
    mean(is.na(df$DHEA_nmol)) * 100
  )
)

#fromat and print missingness table
missing_table %>%
  kable(
    col.names = c("variable", "missing count (n)", "percentage (%)"),
    digits = 1,
    caption = "summary of missing data across primary study variables"
  )
```

## Question 1: Agreement Analysis
```{r}
#filter data complete pairs of Booklet and MEM times
df_q1 <- df %>%
  filter(!is.na(Booklet_Min_Since_Wake) & !is.na(MEMs_Min_Since_Wake)) %>%
  mutate(bias = Booklet_Min_Since_Wake - MEMs_Min_Since_Wake)
#check df_q1
view(df_q1)

#calculate correlation
correlation_result <- cor(df_q1$Booklet_Min_Since_Wake, df_q1$MEMs_Min_Since_Wake)
print(paste("correlation between booklet and cap:", round(correlation_result, 4)))

#calculate bias summary
bias_summary <- summary(df_q1$bias)
print("summary statistics for bias:")
print(bias_summary)

#make presentation theme
presentation_theme <- theme_minimal(base_size = 18) +
  theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 20, face = "bold"),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_blank()
  )

#visualize bias distribution
#increased binwidth and clearer labels for the histogram
ggplot(df_q1, aes(x = bias)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "white") +
  presentation_theme +
  labs(
    title = "Distribution of Time Differences",
    x = "Bias (booklet - cap minutes)",
    y = "Number of Samples"
  )

# prepare the correlation label
cor_label <- paste0("Correlation: ", round(correlation_result, 3))

# visualize agreement scatterplot
ggplot(df_q1) +
  geom_point(aes(x = MEMs_Min_Since_Wake, y = Booklet_Min_Since_Wake, color = "Observed Samples"), 
             alpha = 0.4, size = 3) +
  geom_abline(aes(intercept = 0, slope = 1, color = "Perfect Agreement Line"), 
              linetype = "dashed", linewidth = 1.2) +
  annotate("text", x = 400, y = 50, label = cor_label, 
           size = 5, fontface = "italic", color = "grey30") +
  scale_color_manual(name = NULL, 
                     values = c("Observed Samples" = "darkblue", "Perfect Agreement Line" = "red")) +
  presentation_theme +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key = element_blank()
  ) +
  labs(
    title = "Agreement Between Booklet and Cap Clocks",
    x = "Cap Minutes Since Wake",
    y = "Booklet Minutes Since Wake"
  )


#linear mixed model: random intercept only
# this accounts for the fact that each subject has a different baseline bias
model_intercept <- lmer(Booklet_Min_Since_Wake ~ MEMs_Min_Since_Wake + 
                          (1 | SubjectID), 
                        data = df_q1)
summary(model_intercept)


#linear mixed model: random intercept and slope
#predictor is centered to help convergence
df_q1 <- df_q1 %>%
  mutate(MEMs_centered = MEMs_Min_Since_Wake - mean(MEMs_Min_Since_Wake, na.rm = TRUE))

agreement_model_final <- lmer(Booklet_Min_Since_Wake ~ MEMs_centered + 
                                (1 + MEMs_centered | SubjectID), 
                              data = df_q1,
                              control = lmerControl(optimizer = "nlminbwrap",
                                                   optCtrl = list(maxfun = 1e5)))
                              
summary(agreement_model_final)

#compare to see if the random slope improves fit
anova(model_intercept, agreement_model_final)
```
## Question 2: Adherence Analysis

```{r}
#make new column with target time, calculate difference between actual (MEM) time and target time
df_q2 <- df %>%
  filter(Collection.Sample %in% c(2, 4)) %>%
  mutate(
    Target = ifelse(Collection.Sample == 2, 30, 600),
    Time_Diff = MEMs_Min_Since_Wake - Target,
    Abs_Diff = abs(Time_Diff)
  ) %>%
  filter(!is.na(Time_Diff))

#create adherence categories (within 7.5 or 15 minutes)
df_q2 <- df_q2 %>%
  mutate(
    In_7.5_Window = Abs_Diff <= 7.5,
    In_15_Window = Abs_Diff <= 15
  )

#proportion of adherence table
adherence_proportions <- df_q2 %>%
  group_by(Collection.Sample) %>%
  summarise(
    Total_n = n(),
    Strict_Adherence_n = sum(In_7.5_Window),
    Strict_Rate = (Strict_Adherence_n / Total_n) * 100,
    Lenient_Adherence_n = sum(In_15_Window),
    Lenient_Rate = (Lenient_Adherence_n / Total_n) * 100
  )

kable(adherence_proportions, digits = 1, caption = "Proportions of Adherent Samples")

#descriptive statistics table
timing_descriptives <- df_q2 %>%
  group_by(Collection.Sample) %>%
  summarise(
    Mean_Diff = mean(Time_Diff),
    Median_Diff = median(Time_Diff),
    SD_Diff = sd(Time_Diff),
    Min_Diff = min(Time_Diff),
    Max_Diff = max(Time_Diff)
  )

kable(timing_descriptives, digits = 1, caption = "Descriptive Statistics of Timing Deviations (Minutes)")

#visualize the spread of timing deviations
ggplot(df_q2, aes(x = factor(Collection.Sample), y = Time_Diff, fill = factor(Collection.Sample))) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", linewidth = 1) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -15, ymax = 15, alpha = .1, fill = "green") +
  geom_boxplot(width = 0.5, outlier.color = "red", alpha = 0.7) +
  scale_x_discrete(labels = c("2" = "30-Min Target", "4" = "10-Hour Target")) +
  scale_fill_manual(values = c("steelblue", "darkblue")) +
  presentation_theme +
  theme(legend.position = "none") +
  labs(
    title = "Distribution of Protocol Deviations",
    subtitle = "Green shaded area represents the Â±15 min window",
    x = "Scheduled Sample",
    y = "Minutes Off-Target (Actual - Target)"
  )
```

## Question 3: Changes in DHEA and Cortisol throughout the day
```{r}

#create cleaned cortisol dataframe by excluding values over 80 nmol/L as per investigator instructions
df_cort_clean <- df %>%
  filter(!is.na(Cortisol_nmol)) %>%
  filter(Cortisol_nmol <= 80)

#create cleaned dhea dataframe
#identify and remove subjects with multiple measures at the detection limit (5.205)
subjects_to_exclude_dhea <- df %>%
  filter(!is.na(DHEA_nmol)) %>%
  group_by(SubjectID) %>%
  summarise(limit_count = sum(DHEA_nmol >= 5.205)) %>%
  filter(limit_count > 1) %>%
  pull(SubjectID)

#filter by removing limit values and excluded subjects
df_dhea_clean <- df %>%
  filter(!is.na(DHEA_nmol)) %>%
  filter(DHEA_nmol < 5.205) %>%
  filter(!(SubjectID %in% subjects_to_exclude_dhea))

# Print summary of cleaning actions
print(paste("Number of Samples removed for Cortisol (>80):", sum(df$Cortisol_nmol > 80, na.rm = TRUE)))
print(paste("SubjectID excluded from DHEA df:", 
            paste(subjects_to_exclude_dhea, collapse = ", ")))

#make piecewise time variable for cortisol data and DHEA data

#cortisol
df_cort_clean <- df_cort_clean %>%
  mutate(
    #slope 1: slope from time 0 0 to 30 minutes
    time_rise = pmin(MEMs_Min_Since_Wake, 30),
    
    #slope 2: starts at 0, only begins increasing after the 30-min mark.
    time_decline = pmax(0, MEMs_Min_Since_Wake - 30)
  )

#dhea
df_dhea_clean <- df_dhea_clean %>%
  mutate(
    #slope 1
    time_rise = pmin(MEMs_Min_Since_Wake, 30),
    #slope 2
    time_decline = pmax(0, MEMs_Min_Since_Wake - 30)
  )

#piecewise linear mixed models

#cortisol- log transformations added to outcome variables
cort_model <- lmer(log(Cortisol_nmol) ~ time_rise + time_decline + (1 | SubjectID), 
                   data = df_cort_clean)
summary(cort_model)

#DHEA model 
dhea_model <- lmer(log(DHEA_nmol) ~ time_rise + time_decline + (1 | SubjectID), 
                   data = df_dhea_clean)
summary(dhea_model)


```

```{r}
# tidy models, include 95% confidence intervals
cort_tidy_ci <- tidy(cort_model, effects = "fixed", conf.int = TRUE, conf.level = 0.95) %>% 
  mutate(Hormone = "Cortisol")

dhea_tidy_ci <- tidy(dhea_model, effects = "fixed", conf.int = TRUE, conf.level = 0.95) %>% 
  mutate(Hormone = "DHEA")

#prepare for display in table
hormone_final_table <- bind_rows(cort_tidy_ci, dhea_tidy_ci) %>%
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Wake Level (Intercept)",
      term == "time_rise" ~ "Morning Change (0-30 min)",
      term == "time_decline" ~ "Daily Decline (30+ min)"
    ),
    # Combine Lower and Upper into one "95% CI" column for a cleaner look
    conf_interval = paste0("[", round(conf.low, 4), ", ", round(conf.high, 4), "]"),
    estimate = round(estimate, 4),
    p.value = ifelse(p.value < 0.001, "< 0.001", round(p.value, 3))
  ) %>%
  select(Hormone, term, estimate, conf_interval, p.value)

#make table 
hormone_final_table %>%
  kable(
    col.names = c("Hormone", "Model Parameter", "Estimate (Beta)", "95% CI", "p-value"),
    caption = "Diurnal Hormone Trajectories with 95% Confidence Intervals",
    align = "llccc"
  )

#plot 
ggplot(df_cort_clean, aes(x=MEMs_Min_Since_Wake, y=log(Cortisol_nmol)))+
  geom_point()+
  labs(
    title = "MEMs Minutes Since Wake vs Cortisol Levels (nmol)",
    x = "MEM's Minutes Since Wake",
    y = "Cortisol Levels (nmol)")

ggplot(df_dhea_clean, aes(x=MEMs_Min_Since_Wake, y=log(DHEA_nmol)))+
  geom_point()+
  labs(
    title = "MEMs Minutes Since Wake vs DHEA Levels (nmol)",
    x = "MEM's Minutes Since Wake",
    y = "DHEA Levels (nmol)")

```

