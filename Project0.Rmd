---
title: "Project 0"
author: "Emily Kokesh"
date: "2026-01-26"
output: html_document
---
## Data loading and cleaning, missingness analysis
```{r}
# load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(lubridate)
library(knitr)


# load data
path <- "C:/Users/kokeshem/Spring 2026/Advanced Statistical Methods/Project0_Clean_v2.csv"
df <- read.csv(path, na.strings = c("", "NA"))

# data cleaning, renaming, trimming

df <- df %>% 
  rename(
    Booklet_Clock_Time = Booket..Clock.Time, 
    MEMs_Clock_Time = MEMs..Clock.Time,
    Wake_Time = Sleep.Diary.reported.wake.time,
    Cortisol_nmol = Cortisol..nmol.L.,
    DHEA_nmol = DHEA..nmol.L.
  ) %>%
  #remove unnecessary columns for analysis
  select(
    SubjectID, 
    Collection.Date, 
    Collection.Sample, 
    DAYNUMB,
    Booklet_Clock_Time, 
    MEMs_Clock_Time, 
    Wake_Time, 
    Cortisol_nmol, 
    DHEA_nmol
  )

#fill wake time so each sample per day has the same wake time
df <- df %>%
  group_by(SubjectID, Collection.Date) %>%
  fill(Wake_Time, .direction = "downup") %>%
  ungroup()

#helper function
to_mins <- function(time_str) {
  t <- hm(time_str, quiet = TRUE)
  return(as.numeric(t) / 60)
}

#calculate minutes since waking
df <- df %>%
  mutate(
    Wake_Min = to_mins(Wake_Time),
    Booklet_Clock_Min = to_mins(Booklet_Clock_Time),
    MEMs_Clock_Min = to_mins(MEMs_Clock_Time),
    
    #final analysis variables
    Booklet_Min_Since_Wake = Booklet_Clock_Min - Wake_Min,
    MEMs_Min_Since_Wake = MEMs_Clock_Min - Wake_Min
  )

#check simplified structure
str(df)
view(df)

#create missing data frame
missing_table <- data.frame(
  variable = c("mems cap time", "booklet time", "cortisol level", "dhea level"),
  missing_count = c(
    sum(is.na(df$MEMs_Clock_Time)),
    sum(is.na(df$Booklet_Clock_Time)),
    sum(is.na(df$Cortisol_nmol)),
    sum(is.na(df$DHEA_nmol))
  ),
  percentage = c(
    mean(is.na(df$MEMs_Clock_Time)) * 100,
    mean(is.na(df$Booklet_Clock_Time)) * 100,
    mean(is.na(df$Cortisol_nmol)) * 100,
    mean(is.na(df$DHEA_nmol)) * 100
  )
)

#fromat and print missingness table
missing_table %>%
  kable(
    col.names = c("variable", "missing count (n)", "percentage (%)"),
    digits = 1,
    caption = "summary of missing data across primary study variables"
  )
```

## Question 1: Agreement Analysis
```{r}
#filter data complete pairs of Booklet and MEM times
df_q1 <- df %>%
  filter(!is.na(Booklet_Min_Since_Wake) & !is.na(MEMs_Min_Since_Wake)) %>%
  mutate(bias = Booklet_Min_Since_Wake - MEMs_Min_Since_Wake)
#check df_q1
view(df_q1)

#calculate correlation
correlation_result <- cor(df_q1$Booklet_Min_Since_Wake, df_q1$MEMs_Min_Since_Wake)
print(paste("correlation between booklet and cap:", round(correlation_result, 4)))

#calculate bias summary
bias_summary <- summary(df_q1$bias)
print("summary statistics for bias:")
print(bias_summary)

#make presentation theme
presentation_theme <- theme_minimal(base_size = 18) +
  theme(
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 20, face = "bold"),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_blank()
  )

#visualize bias distribution
#increased binwidth and clearer labels for the histogram
ggplot(df_q1, aes(x = bias)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "white") +
  presentation_theme +
  labs(
    title = "Distribution of Time Differences",
    x = "Bias (booklet - cap minutes)",
    y = "Number of Samples"
  )

# prepare the correlation label
cor_label <- paste0("Correlation: ", round(correlation_result, 3))

# visualize agreement scatterplot
ggplot(df_q1) +
  geom_point(aes(x = MEMs_Min_Since_Wake, y = Booklet_Min_Since_Wake, color = "Observed Samples"), 
             alpha = 0.4, size = 3) +
  geom_abline(aes(intercept = 0, slope = 1, color = "Perfect Agreement Line"), 
              linetype = "dashed", linewidth = 1.2) +
  annotate("text", x = 400, y = 50, label = cor_label, 
           size = 5, fontface = "italic", color = "grey30") +
  scale_color_manual(name = NULL, 
                     values = c("Observed Samples" = "darkblue", "Perfect Agreement Line" = "red")) +
  presentation_theme +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.key = element_blank()
  ) +
  labs(
    title = "Agreement Between Booklet and Cap Clocks",
    x = "Cap Minutes Since Wake",
    y = "Booklet Minutes Since Wake"
  )


#linear mixed model: random intercept only
# this accounts for the fact that each subject has a different baseline bias
model_intercept <- lmer(Booklet_Min_Since_Wake ~ MEMs_Min_Since_Wake + 
                          (1 | SubjectID), 
                        data = df_q1)
summary(model_intercept)


#linear mixed model: random intercept and slope
#predictor is centered to help convergence
df_q1 <- df_q1 %>%
  mutate(MEMs_centered = MEMs_Min_Since_Wake - mean(MEMs_Min_Since_Wake, na.rm = TRUE))

agreement_model_final <- lmer(Booklet_Min_Since_Wake ~ MEMs_centered + 
                                (1 + MEMs_centered | SubjectID), 
                              data = df_q1,
                              control = lmerControl(optimizer = "nlminbwrap",
                                                   optCtrl = list(maxfun = 1e5)))
                              
summary(agreement_model_final)

#compare to see if the random slope improves fit
anova(model_intercept, agreement_model_final)
```

